<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Palaeographical Definitions</title>
    <link rel="shortcut icon" href="#">
    <link rel="stylesheet" href="./node_modules/bulma/css/bulma.min.css">
    <link rel="stylesheet" href="./node_modules/font-awesome5/css/fontawesome-all.min.css"/>

    <script src="./node_modules/vue/dist/vue.global.js"></script>
    <script src="utils.js"></script>
    <script type="module">
      // TODO: relative import
      import { Octokit } from "https://cdn.skypack.dev/@octokit/core";
      // import { Octokit } from "./node_modules/@octokit/core/dist-web/index.js";
      window.Octokit = Octokit
    </script>    
    <link rel="stylesheet" href="./assets/main.css">
  </head>
  <body>
    <section id="definitions" class="section">
      <div class="tabs is-large is-boxed">
        <ul>
          <li v-for="tab in tabs" :class="{'is-active': selection.tab == tab.key}">
            <a :href="`${tab.key}.html`">
              {{ tab.title }}
              &nbsp;
              <button v-if="selection.tab == tab.key" @click="saveDefinitions()" class="button is-primary">Save</button>
            </a>            
          </li>
        </ul>
      </div>
      <div class="container is-fluid">

        <div class="field">
          <label class="label">Script</label>
          <div class="select">
            <select v-model="selection.script">
              <option v-for="script in definitions.scripts">{{ script }}</option>
            </select>
          </div>
        </div>

        <div class="tabs is-boxed">
          <ul>
            <li v-for="tab in innerTabs" :class="{'is-active': selection.innerTab == tab.key}">
              <a @click.prevent.stop="selection.innerTab = tab.key">
                {{ tab.title }}
              </a>
            </li>
          </ul>
        </div>

        <template v-if="selection.innerTab == 'ac'">
          <table class="table table-def table-ac">
            <tr>
              <td></td>
              <template v-for="allo in definitions.allographs">
                <td v-if="allo.script == selection.script">{{ allo.character }}</td>
              </template>
            </tr>
            <tr v-for="(component, componentSlug) in definitions.components">
              <td>{{ component.name }}</td>
              <template v-for="allo in definitions.allographs">
                <td v-if="allo.script == selection.script" @click.stop.prevent="onClickAllographComponent(allo, componentSlug)">
                  <span v-if="allo.components.includes(componentSlug)" class="checked">✔</span>
                </td>
              </template>
            </tr>
          </table>
        </template>

        <template v-if="selection.innerTab == 'cf'">
          <table class="table table-def table-cf">
            <tr>
              <td></td>
              <td v-for="(feature, featureSlug) in definitions.features">{{ feature }}</td>
            </tr>
            <tr v-for="(component, componentSlug) in definitions.components">
              <td>{{ component.name }}</td>
              <td v-for="(feature, featureSlug) in definitions.features" @click.stop.prevent="onClickComponentFeature(component, featureSlug)">
                <span v-if="component.features.includes(featureSlug)" class="checked">✔</span>
              </td>
            </tr>
          </table>
        </template>

        <template v-if="false">
          <hr>

          <form class="control">
            <label class="label">Archetype homepage URL</label>
            <div class="control">
              <input class="input" type="text" name="archetype_api" :value="archetypeUri">
            </div>
            <div class="control">
              <button @click.prevent.stop="onImportDefinitions()" class="button" type="submit" name="action" value="export-definitions">Import definitions</button>
            </div>
            <div class="control">
              <button @click.prevent.stop="onShortenCollection()" class="button" type="submit" name="action" value="shorten-collection">Shorten collection</button>
            </div>
          </form>
          <textarea style="width:100%; height: 15em;">
            {{ definitions }}
          </textarea>
        </template>
      </div>
    </section>
    <script defer>
      const { createApp } = Vue

      // const componentFeatureUri = '/digipal/api/componentfeature/'
      const componentUri = '/digipal/api/component/?@select=name,*componentfeature_set,feature'
      const allographUri = '/digipal/api/allograph/?@select=*script_set,*allograph_components,name,character,*component'
      const collectionUri = './data/dts/api/collections.json'
      const definitionsPath = 'app/data/pal/definitions-digipal.json'

      createApp({
        data() {
          return {
            archetypeUri: '//digipal.eu',
            definitions: {'k1': 'v1'},
            definitionsSha: null,
            selection: {
              script: '',
              tab: 'definitions',
              innerTab: 'cf',
              gtoken: window.localStorage.getItem('gtoken') || '',
            },
          }
        },
        computed: {
          tabs: () => utils.tabs(),
          innerTabs() {
            return [
              {title: 'Allographs x Components', key: 'ac'},
              {title: 'Components x Features', key: 'cf'},
            ]
          }
        },
        mounted() {
          // so we are sure all js modules have been loaded
          window.addEventListener("load", (event) => {
            console.log('load defs')
            this.loadDefinitions()
          });      
        },
        methods: {
          onClickAllographComponent(allo, componentSlug) {
            if (allo.components.includes(componentSlug)) {
              allo.components = allo.components.filter((c) => c != componentSlug)
            } else {
              allo.components.push(componentSlug)
            }
          },
          onClickComponentFeature(component, featureSlug) {
            if (component.features.includes(featureSlug)) {
              component.features = component.features.filter((f) => f != featureSlug)
            } else {
              component.features.push(featureSlug)
            }
          },
          getOctokit() {
            // TODO: create wrapper class around Octokit
            // TODO: cache this
            let ret = null
            if (this.selection.gtoken) {
              ret = new Octokit({
                auth: this.selection.gtoken
              })
            }
            return ret
          },
          async loadDefinitions() {
            // TODO: temporarily locals
            // let res = await utils.readGithubJsonFile(definitionsPath, this.getOctokit())
            let res = await utils.readGithubJsonFile('../' + definitionsPath)
            if (res) {
              this.definitions = res.data
              this.definitionsSha = res.sha

              // TODO: case when empty
              this.selection.script = Object.keys(this.definitions.scripts)[0]
            }
          },
          async saveDefinitions() {
            // TODO: sha
            await utils.updateGithubJsonFile(definitionsPath, this.definitions, this.getOctokit(), this.definitionsSha)
          },
          onShortenCollection(e) {
            const self = this;
            let uri = collectionUri;

            const toKeep = new RegExp('ISic0000(01|07|31|46|79)$')

            fetch(uri).then(r => r.json()).then(res => {
              ret = res

              ret.member = ret.member.filter(
                m => 
                !!(m && m.title.match(toKeep))
              )

              ret.totalItems = ret.member.length
              ret['dts:totalChildren'] = ret.member.length

              self.definitions = ret
            })
            
          },
          onImportDefinitions(e) {
            const self = this;
            let uri = self.archetypeUri + componentUri;

            fetch(uri).then(r => r.json()).then(res => {
              let features = {};
              let components = {};
              for (let c of res.results) {
                components[this.slugify(c.name)] = {
                  name: c.name,
                  features: c.componentfeature_set.map(cf => this.slugify(cf.feature))
                }
                for (cf of c.componentfeature_set) {
                  features[this.slugify(cf.feature)] = cf.feature
                }
              }

              uri = self.archetypeUri + allographUri;
              fetch(uri).then(r => r.json()).then(res => {
                const allographs = {};
                
                for (let a of res.results) {
                  let allograph_name = a.character

                  let allograph = {
                    script: 'SCRIPT',
                    character: a.character,
                    components: a.allograph_components.map(c =>
                      this.slugify(c.component.name)
                    )
                  }
                  allographs[this.slugify(allograph_name, true)] = allograph
                }

                let ret = {
                  'context': self.archetypeUri,
                  'version': '0.1',
                  'updated': new Date().toISOString(),
                  'scripts': {},
                  'features': features,
                  'components': components,
                  'allographs': allographs,
                };
                self.definitions = ret;
              })
            })
          },
          slugify(text, preserveCase=false) {
            // stolen from https://gist.github.com/codeguy/6684588?permalink_comment_id=4176055#gistcomment-4176055
            ret = text
              .toString()                           // Cast to string (optional)
              .normalize('NFKD')            // The normalize() using NFKD method returns the Unicode Normalization Form of a given string.

            if (!preserveCase)
              ret = ret
              .toLowerCase()                  // Convert the string to lowercase letters

            ret = ret
              .trim()                                  // Remove whitespace from both sides of a string (optional)
              .replace(/\s+/g, '-')            // Replace spaces with -
              .replace(/[^\w\-]+/g, '')     // Remove all non-word chars
              .replace(/\-\-+/g, '-');        // Replace multiple - with single -
            
            return ret
          }
        }
      }).mount('#definitions')
    </script>
  </body>
</html>