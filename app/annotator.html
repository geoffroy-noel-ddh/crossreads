<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Annotator</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <link rel="stylesheet" href="./node_modules/bulma/css/bulma.min.css">
    <link rel="stylesheet" href="./node_modules/font-awesome5/css/fontawesome-all.min.css"/>

    <script src="./node_modules/openseadragon/build/openseadragon/openseadragon.min.js"></script>
    <link rel="stylesheet" href="./node_modules/@recogito/annotorious-openseadragon/dist/annotorious.min.css">
    <script src="./node_modules/@recogito/annotorious-openseadragon/dist/openseadragon-annotorious.min.js"></script>

    <!-- importmap shim for Firefox -->
    <script src="./node_modules/vue/dist/vue.global.js"></script>
    <link rel="stylesheet" href="./assets/main.css">

    <script src="utils.js"></script>
    <script type="module">
      // TODO: UPGRADE
      // TODO: relative import
      // TODO: modularise use of octokit, create a wrapper
      // TODO: don't import it globally.
      // import { Octokit } from "https://esm.sh/@octokit/core";
      // import { Octokit } from "https://cdn.skypack.dev/@octokit/rest";
      // import { Octokit, App } from "https://esm.sh/octokit";
      import { Octokit, App } from "https://cdn.skypack.dev/octokit@2.0.14";
      // import { Octokit } from "./node_modules/@octokit/core/dist-web/index.js";
      window.Octokit = Octokit
    </script>    
    <script src="assets/annotator.js" defer></script>

  </head>
  <body>
    <section class="section full-width" id="annotator">
      <!-- <button @click="loadAnnotationsFromSession()">Load</button>
      <button @click="saveAnnotationsToSession()">Save</button> -->
      <div class="container is-fluid">
        <div :class="['notification', 'is-'+lastMessage.level, 'is-light']">
          {{ lastMessage.content }}
        </div>
        <div class="tabs is-medium is-boxed">
          <ul>
            <li v-for="tab in tabs" :class="{'is-active': selection.tab == tab.key}">
              <a :href="`${tab.key}.html${queryString}`">
                <template v-if="!canSave && tab.key == 'settings'"><i class="fas fa-exclamation-triangle"></i>&nbsp;</template>
                {{ tab.title }}
              </a>
            </li>
          </ul>
          <a href="https://github.com/kingsdigitallab/crossreads/issues" target="_blank" class="icon-text">
            <span class="icon"><i class="fas fa-bug"></i></span>
            <span>Issues</span>
          </a>
        </div>
        <div class="columns is-3">
          <div class="column">
            <div class="panel panel-objects">
              <p class="panel-heading">
                Objects
              </p>
              <div class="panel-block">
                <p class="control has-icons-left">
                  <input class="input" type="text" placeholder="Search" v-model="searchPhrase">
                  <span class="icon is-left">
                    <i class="fas fa-search" aria-hidden="true"></i>
                  </span>
                </p>
              </div>
              <div class="panel-block">
                <ul class="list-selectable">
                  <a v-for="(obj2, idx) in filteredObjects" href="#" @click.prevent="onSelectObject(obj2)">
                    <li :class="{'selected': obj2['@id'] == selection.object}">
                      {{ obj2.title }}
                    </li>
                  </a>
                </ul>
                <!-- <div class="select list-objects">
                  <select v-model="object" size="10">
                    <option v-for="(obj2, idx) in filteredObjects">{{ obj2.name }}</option>
                  </select>
                </div> -->
              </div>
              <p class="panel-heading">
                Images
              </p>
              <div class="panel-block">
                <ul class="list-selectable">
                  <a v-for="(img, idx) in filteredImages" href="#" @click.prevent="onSelectImage(img)">
                    <li :class="{'selected': img == image}">
                      {{ img.uri }}
                    </li>
                  </a>
                </ul>
              </div>
            </div>
          </div>
          <div class="column is-6">
            <div class="panel">
              <p class="panel-heading">
                Image
                <span class="side-links">
                  <button @click="onClickSave()" class="button is-small is-default" :disabled="!canSave || !isUnsaved">
                    <template v-if="!canSave">Read Only</template>
                    <template v-else>
                      <template v-if="isUnsaved">Save</template><template v-else>Saved</template>
                    </template>
                  </button>
                </span>
              </p>
              <div class="panel-block">
                <div id="image-viewer" style="width: 100%; height: 300px;"></div>
              </div>
              <p class="panel-heading">
                Transcription
                <span class="side-links">
                  <label>
                    <input type="checkbox" v-model="selection.showSuppliedText">
                    Show supplied text
                  </label>
                </span>
              </p>
              <div class="panel-block transcription fill-height">
                <p :class="{'show-supplied': selection.showSuppliedText, 'transcription-body': 1}" v-html="text">
                </p>
              </div>
            </div>
          </div>
          <div class="column is-3">
            <div class="panel">
              <p class="panel-heading">
                Description
                <span v-if="isAnnotationSelected">(Selected)</span>
              </p>
              <div class="panel-block fill-height">
                <dl class="description">
                  <dt>Script</dt> 
                  <dd>
                    <div class="select">
                      <select v-model="description.script" @change="onChangeScript()" :disabled="!canSave">
                        <option v-for="(script, scriptKey) in filteredScripts" :value="scriptKey">{{ script }}</option>
                      </select>
                    </div>
                  </dd>
                  <dt>Allograph ({{description.allograph}})</dt> 
                  <dd>
                    <!-- <span v-if="!(description.allograph in definitions.allographs)">{{description.allograph}}</span> -->
                    <div class="select">
                      <select v-model="description.allograph" @change="onChangeAllograph()" :disabled="!canSave">
                        <option v-for="(allograph, allographKey) in filteredAllographs" :value="allographKey">{{ allograph.character }} <template v-if="allograph.script == 'base'">(BASE)</template></option>
                      </select>
                    </div>
                  </dd>
                  <dt>Components</dt> 
                  <dd><ul class="components-features">
                    <li v-for="(component, componentKey) in filteredComponents">
                      <span class="component-name">
                        <template v-if="definitions.components[componentKey]">
                          {{ definitions.components[componentKey].name }}
                        </template>
                        <template v-else>
                          {{ componentKey }} [Undefined]
                        </template>
                      </span>
                      <ul>
                        <li v-for="featureKey in component.features">
                          <label :class="{selectable: true, selected: isComponentFeatureSelected(componentKey, featureKey)}">
                            <input type="checkbox" @change="onChangeComponentFeature(componentKey, featureKey)" :checked="isComponentFeatureSelected(componentKey, featureKey)" :disabled="!canSave">
                            <template v-if="definitions.features[featureKey]"> 
                              {{ definitions.features[featureKey] }}
                            </template>
                            <template v-else>
                              {{ featureKey }} [Undefined]
                            </template>
                          </label>
                        </li>
                      </ul>
                    </li>
                  </ul></dd>
                </dl>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </body>
</html>
